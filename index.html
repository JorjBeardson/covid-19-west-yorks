<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta charset="utf-8" />
	<title>West Yorkshire COVID-19 Dashboard</title>
	<link rel="StyleSheet" href="resources/style.css" type="text/css" />
</head>
<body class="b1-bg">

	<div class="b1-bg padded">
		<div class="holder">
			<h1>West Yorkshire COVID-19 Dashboard</h1>
		</div>
	</div>

	<div class="b6-bg doublepadded">
		<div>
			<section class="grid">
				<h2 class="E08000032 row-1" tabindex="0">Bradford</h2>
				<div class="E08000032 row-2 population padded" tabindex="0"></div>
				<div class="E08000032 row-3 total padded" tabindex="0"></div>
				<div class="E08000032 row-4 weekly padded" tabindex="0"></div>
				<div class="E08000032 row-5 weekly-change padded" tabindex="0"></div>
				<div class="E08000032 row-6 total-percapita padded" tabindex="0"></div>
				<div class="E08000032 row-7 weekly-percapita padded" tabindex="0"></div>

				<h2 class="E08000033 row-1" tabindex="0">Calderdale</h2>
				<div class="E08000033 row-2 population padded" tabindex="0"></div>
				<div class="E08000033 row-3 total padded" tabindex="0"></div>
				<div class="E08000033 row-4 weekly padded" tabindex="0"></div>
				<div class="E08000033 row-5 weekly-change padded" tabindex="0"></div>
				<div class="E08000033 row-6 total-percapita padded" tabindex="0"></div>
				<div class="E08000033 row-7 weekly-percapita padded" tabindex="0"></div>

				<h2 class="E08000034 row-1" tabindex="0">Kirklees</h2>
				<div class="E08000034 row-2 population padded" tabindex="0"></div>
				<div class="E08000034 row-3 total padded" tabindex="0"></div>
				<div class="E08000034 row-4 weekly padded" tabindex="0"></div>
				<div class="E08000034 row-5 weekly-change padded" tabindex="0"></div>
				<div class="E08000034 row-6 total-percapita padded" tabindex="0"></div>
				<div class="E08000034 row-7 weekly-percapita padded" tabindex="0"></div>

				<h2 class="E08000035 row-1" tabindex="0">Leeds</h2>
				<div class="E08000035 row-2 population padded" tabindex="0"></div>
				<div class="E08000035 row-3 total padded" tabindex="0"></div>
				<div class="E08000035 row-4 weekly padded" tabindex="0"></div>
				<div class="E08000035 row-5 weekly-change padded" tabindex="0"></div>
				<div class="E08000035 row-6 total-percapita padded" tabindex="0"></div>
				<div class="E08000035 row-7 weekly-percapita padded" tabindex="0"></div>

				<h2 class="E08000036 row-1" tabindex="0">Wakefield</h2>
				<div class="E08000036 row-2 population padded" tabindex="0"></div>
				<div class="E08000036 row-3 total padded" tabindex="0"></div>
				<div class="E08000036 row-4 weekly padded" tabindex="0"></div>
				<div class="E08000036 row-5 weekly-change padded" tabindex="0"></div>
				<div class="E08000036 row-6 total-percapita padded" tabindex="0"></div>
				<div class="E08000036 row-7 weekly-percapita padded" tabindex="0"></div>
			</ul>

		</div>
	</div>

	<footer class="b1-bg">
		<div class="holder">
			Â© 2020 <a href="https://odileeds.org/">ODI Leeds</a>. Released under an MIT license. <a href="https://github.com/odileeds/covid-19-west-yorks">Source on Github</a>.
		</div>
	</footer>

	<script>
	// shim layer with setTimeout fallback
	window.requestAnimFrame = (function(){
		return  window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || function( callback ){ window.setTimeout(callback, 1000 / 60); };
	})();
	var pop = {"E08000032":540909,"E08000033":210958,"E08000034":441772,"E08000035":795565,"E08000036":352983};
	var lad = {};
	function initPanels(la){
		for(var id in lad[la].panels){
			panels = lad[la].panels[id];
			lad[la].panels[id] = {'_parent':document.querySelector('.'+la+'.'+id)};
			if(lad[la].panels[id]._parent){
				lad[la].panels[id]._parent.innerHTML = "";
				for(var p = 0; p < panels.length; p++){
					lad[la].panels[id][panels[p].type] = document.createElement(panels[p].tagname);
					lad[la].panels[id][panels[p].type].classList.add(panels[p]['type']);
					if(panels[p]['class']) lad[la].panels[id][panels[p].type].classList.add(panels[p]['class']);
					lad[la].panels[id][panels[p].type].innerHTML = panels[p].html;
					lad[la].panels[id]._parent.append(lad[la].panels[id][panels[p].type]);
					if(panels[p]['type'] == "number"){
						load = document.createElement('img');
						load.src = "resources/odi.svg";
						load.classList.add('spinner');
						lad[la].panels[id][panels[p].type].append(load);
					}
				}
			}else{
				console.error("Can't find "+la+"."+id);
			}
		}
		return;
	}
	function displayLA(la){
	
		lad[la].panels['population'].number.innerHTML = pop[la].toLocaleString();
	
		// Show total
		animateNumber(lad[la].panels['total'].number,lad[la].json.data[0]['cumCasesBySpecimenDate'],300,'');
		lad[la].panels['total'].updated.innerHTML = lad[la].json.data[0].date;

		// Show total/100,000
		animateNumber(lad[la].panels['total-percapita'].number,Math.round(lad[la].json.data[0]['cumCasesBySpecimenDate']*1e5/pop[la]),300,'');
		lad[la].panels['total-percapita'].updated.innerHTML = lad[la].json.data[0].date;

		// Work out weekly totals
		var latest = new Date(lad[la].json.data[0].date);
		var weeks = [{'total':0,'days':0,'upto':lad[la].json.data[0].date}];
		for(var i = 0; i < lad[la].json.data.length; i++){
			d = new Date(lad[la].json.data[i].date);
			w = Math.floor(((latest-d)/86400000)/7);
			if(weeks.length <= w) weeks.push({'total':0,'days':0,'upto':lad[la].json.data[i].date});
			weeks[w].total += lad[la].json.data[i]['newCasesBySpecimenDate'];
			weeks[w].days++;
		}
		if(weeks[0].days == 7){
			animateNumber(lad[la].panels['weekly'].number,weeks[0].total,300,'');
			lad[la].panels['weekly'].updated.innerHTML = 'Up to '+lad[la].json.data[0].date;
			
			if(lad[la].panels['weekly-percapita']._parent){
				animateNumber(lad[la].panels['weekly-percapita'].number,Math.round(weeks[0].total*1e5/pop[la]),300,'');
				lad[la].panels['weekly-percapita'].updated.innerHTML = 'Up to '+lad[la].json.data[0].date;
			}
		}
		if(weeks[0].days == 7 && weeks[1].days == 7){
			animateNumber(lad[la].panels['weekly-change'].number,weeks[0].total-weeks[1].total,300,'');
			lad[la].panels['weekly-change'].updated.innerHTML = weeks[0].upto+' vs '+weeks[1].upto;
		}else{
			lad[la].panels['weekly-change'].number.innerHTML = "Missing data";
		}


		return this;
	}
	function getDataForLA(la){
		url = "https://api.coronavirus.data.gov.uk/v1/data?filters=areaType=ltla;areaCode={{LA}}&structure=%7B%22date%22:%22date%22,%22areaName%22:%22areaName%22,%22areaCode%22:%22areaCode%22,%22newCasesBySpecimenDate%22:%22newCasesBySpecimenDate%22,%22cumCasesBySpecimenDate%22:%22cumCasesBySpecimenDate%22%7D&format=json";
		//url = "temp/{{LA}}.json";
		lad[la] = {'url':url};
		url = url.replace(/\{\{LA\}\}/,la);
		console.info('Getting data for '+la+' from '+url);
		lad[la].panels = {
			'population': [{'tagname':'h3','type':'title','html':'Population'},{'tagname':'div','type':'number','class':'small','html':''}],
			'total': [{'tagname':'h3','type':'title','html':'Total cases'},{'tagname':'div','type':'number','html':''},{'tagname':'div','type':'updated','html':'2020'}],
			'total-percapita': [{'tagname':'h3','type':'title','html':'Total cases/100,000'},{'tagname':'div','type':'number','html':''},{'tagname':'div','type':'updated','html':'2020'}],
			'weekly': [{'tagname':'h3','type':'title','html':'Weekly cases'},{'tagname':'div','type':'number','html':''},{'tagname':'div','type':'updated','html':''}],
			'weekly-percapita': [{'tagname':'h3','type':'title','html':'Weekly cases/100,000'},{'tagname':'div','type':'number','html':''},{'tagname':'div','type':'updated','html':''}],
			'weekly-change': [{'tagname':'h3','type':'title','html':'Change on previous week'},{'tagname':'div','type':'number','html':''},{'tagname':'div','type':'updated','html':''}]
		};
		initPanels(la);
		
		return fetch(url,{'method':'GET'})
		.then(response => { return response.json() })
		.then(json => {
			lad[la].json = json;
			//load.parentNode.removeChild(load);
			displayLA(la);
		}).catch(error => {
			console.error(error,url);
			lad[la] = {};
		});
	}
	function formatNumber(v){
		if(typeof v !== "number") return v;
		if(v > 1e7) return Math.round(v/1e6)+"M";
		if(v > 1e6) return (v/1e6).toFixed(1)+"M";
		if(v > 1e5) return Math.round(v/1e3)+"k";
		if(v > 1e4) return Math.round(v/1e3)+"k";
		return v;
	}
	function animateNumber(el,val,duration,units){
		if(typeof val!=="number"){
			val = el.innerHTML;
			if(val) val = parseFloat(val);
			el.innerHTML = '';
		}
		el.innerHTML = '';
		if(!units) units = "";
		var start = new Date();
		var v;
		function frame(){
			var now = new Date();
			// Set the current time in seconds
			var f = (now - start)/duration;
			if(f < 1){
				v = formatNumber(Math.round(val*f));
				el.innerHTML = (units+v);
				requestAnimFrame(frame);
			}else{
				el.innerHTML = (units+formatNumber(val));
			}
		}
		if(typeof val==="number") frame();
		return;			
	}
	
	var promises = [];
	for(var la in pop) promises.push(getDataForLA(la));
	
	promises.map(p => p.catch(e => e));
	Promise.all(promises).then(responses => {
		console.log('here');
	});
	
	
	</script>
</body>
</html>