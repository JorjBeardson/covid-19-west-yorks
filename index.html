<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta charset="utf-8" />
	<title>West Yorkshire COVID-19 Dashboard</title>
	<link rel="StyleSheet" href="resources/style.css" type="text/css" />
	<script src="resources/fittext.js"></script>
	<script src="resources/clone.js"></script>
	<script src="resources/graph.js"></script>
	<style>
	.grid .E08000032 { background-color: #006871; color: white; }
	.grid .E08000033 { background-color: #3a843e; color: white; }
	.grid .E08000034 { background-color: #0098b4; color: white; }
	.grid .E08000035 { background-color: #007299; color: white; }
	.grid .E08000036 { background-color: #333086; color: white; }
	</style>
</head>
<body class="b1-bg">

	<div class="b1-bg padded">
		<div class="holder">
			<h1>West Yorkshire COVID-19 Dashboard</h1>
		</div>
	</div>

	<div id="dashboard">
		<section class="grid doublepadded b6-bg">
			<h2 id="E08000032" class="E08000032 cell row-1 authority" tabindex="0"><a href="https://findthatpostcode.uk/areas/E08000032.html">Bradford</a></h2>
			<h2 id="E08000033" class="E08000033 cell row-1 authority" tabindex="0"><a href="https://findthatpostcode.uk/areas/E08000033.html">Calderdale</a></h2>
			<h2 id="E08000034" class="E08000034 cell row-1 authority" tabindex="0"><a href="https://findthatpostcode.uk/areas/E08000034.html">Kirklees</a></h2>
			<h2 id="E08000035" class="E08000035 cell row-1 authority" tabindex="0"><a href="https://findthatpostcode.uk/areas/E08000035.html">Leeds</a></h2>
			<h2 id="E08000036" class="E08000036 cell row-1 authority" tabindex="0"><a href="https://findthatpostcode.uk/areas/E08000036.html">Wakefield</a></h2>
<!--			<h2 id="E08000037" class="E08000037 cell row-1 authority" tabindex="0"><a href="https://findthatpostcode.uk/areas/E08000036.html">Other</a></h2>
			<h2 id="E08000022" class="E08000022 cell row-1 authority" tabindex="0"><a href="https://findthatpostcode.uk/areas/E08000036.html">Other</a></h2>
			<h2 id="E08000023" class="E08000023 cell row-1 authority" tabindex="0"><a href="https://findthatpostcode.uk/areas/E08000036.html">Other</a></h2>
			<h2 id="E08000024" class="E08000024 cell row-1 authority" tabindex="0"><a href="https://findthatpostcode.uk/areas/E08000036.html">Other</a></h2>
			<h2 id="E08000025" class="E08000025 cell row-1 authority" tabindex="0"><a href="https://findthatpostcode.uk/areas/E08000036.html">Other</a></h2>
-->
		</section>
	</div>

	<footer class="b1-bg">
		<div class="holder">
			Â© 2020 <a href="https://odileeds.org/">ODI Leeds</a>. <a href="https://coronavirus.data.gov.uk/">Cases data comes from Public Health England</a> and <a href="https://www.ons.gov.uk/datasets/weekly-deaths-local-authority/editions/time-series/versions">death data comes from ONS</a>.
			<br />Code released under an MIT license. <a href="https://github.com/odileeds/covid-19-west-yorks">Source on Github</a>.
			<p><a href="https://github.com/odileeds/covid-19/tree/master/LocalAuthorities/data">We process the ONS weekly death data</a> - England and Wales - for our <a href="https://odileeds.github.io/covid-19/LocalAuthorities/hexmap.html">UK local authority hexmaps</a> (<a href="https://odileeds.github.io/covid-19/LocalAuthorities/data/death-summary.json">json</a>). ONS tend to publish the death data once per week on Tuesdays so the dates are given in each panel. Data on confirmed cases are from five requests (<a href="https://api.coronavirus.data.gov.uk/v1/data?filters=areaType=ltla;areaCode=E08000032&structure=%7B%22date%22:%22date%22,%22areaName%22:%22areaName%22,%22areaCode%22:%22areaCode%22,%22newCasesBySpecimenDate%22:%22newCasesBySpecimenDate%22,%22cumCasesBySpecimenDate%22:%22cumCasesBySpecimenDate%22%7D&format=json">Bradford</a>, <a href="https://api.coronavirus.data.gov.uk/v1/data?filters=areaType=ltla;areaCode=E08000033&structure=%7B%22date%22:%22date%22,%22areaName%22:%22areaName%22,%22areaCode%22:%22areaCode%22,%22newCasesBySpecimenDate%22:%22newCasesBySpecimenDate%22,%22cumCasesBySpecimenDate%22:%22cumCasesBySpecimenDate%22%7D&format=json">Calderdale</a>, <a href="https://api.coronavirus.data.gov.uk/v1/data?filters=areaType=ltla;areaCode=E08000034&structure=%7B%22date%22:%22date%22,%22areaName%22:%22areaName%22,%22areaCode%22:%22areaCode%22,%22newCasesBySpecimenDate%22:%22newCasesBySpecimenDate%22,%22cumCasesBySpecimenDate%22:%22cumCasesBySpecimenDate%22%7D&format=json">Kirklees</a>, <a href="https://api.coronavirus.data.gov.uk/v1/data?filters=areaType=ltla;areaCode=E08000035&structure=%7B%22date%22:%22date%22,%22areaName%22:%22areaName%22,%22areaCode%22:%22areaCode%22,%22newCasesBySpecimenDate%22:%22newCasesBySpecimenDate%22,%22cumCasesBySpecimenDate%22:%22cumCasesBySpecimenDate%22%7D&format=json">Leeds</a>, and <a href="https://api.coronavirus.data.gov.uk/v1/data?filters=areaType=ltla;areaCode=E08000036&structure=%7B%22date%22:%22date%22,%22areaName%22:%22areaName%22,%22areaCode%22:%22areaCode%22,%22newCasesBySpecimenDate%22:%22newCasesBySpecimenDate%22,%22cumCasesBySpecimenDate%22:%22cumCasesBySpecimenDate%22%7D&format=json">Wakefield</a>) to <a href="https://coronavirus.data.gov.uk/developers-guide">Public Health England's API</a>.</p>
		</div>
	</footer>

	<script>
	// shim layer with setTimeout fallback
	window.requestAnimFrame = (function(){
		return  window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || function( callback ){ window.setTimeout(callback, 1000 / 60); };
	})();
	var panel = {
		'population': [
			{'tagname':'h3','key':'title','html':'Population'},
			{'tagname':'div','key':'number','html':function(la){ return (pop[la]||'?'); },'fit':true}
		],
		'total': [
			{'tagname':'h3','key':'title','html':'Total cases'},
			{'tagname':'div','key':'number','html':function(la){ return lad[la].json.data[0]['cumCasesBySpecimenDate']; },'fit':true},
			{'tagname':'div','key':'updated','html':function(la){ return lad[la].json.data[0].date; }}
		],
		'total-percapita': [
			{'tagname':'h3','key':'title','html':'Total cases/100,000'},
			{'tagname':'div','key':'number','html':function(la){ return (pop[la] ? Math.round(lad[la].json.data[0]['cumCasesBySpecimenDate']*1e5/pop[la]) : '?'); },'fit':true},
			{'tagname':'div','key':'updated','html':function(la){ return lad[la].json.data[0].date; }}
		],
		'weekly': [
			{'tagname':'h3','key':'title','html':'Weekly cases'},
			{'tagname':'div','key':'number','html':function(la){ return (lad[la].weeks[0].days == 7 ? lad[la].weeks[0].total : ''); },'fit':true},
			{'tagname':'div','key':'updated','html':function(la){ return 'Up to '+lad[la].json.data[0].date; }}
		],
		'weekly-percapita': [
			{'tagname':'h3','key':'title','html':'Weekly cases/100,000'},
			{'tagname':'div','key':'number','html':function(la){ return (lad[la].weeks[0].days == 7 && pop[la] ? Math.round(lad[la].weeks[0].total*1e5/pop[la]) : '?'); },'fit':true},
			{'tagname':'div','key':'updated','html':function(la){ return 'Up to '+lad[la].json.data[0].date; }}
		],
		'weekly-change': [
			{'tagname':'h3','key':'title','html':'Change on previous week'},
			{'tagname':'div','key':'number','html':function(la){ return (lad[la].weeks[0].days==7 && lad[la].weeks[1].days==7 ? (lad[la].weeks[0].total - lad[la].weeks[1].total) : ''); },'fit':true},
			{'tagname':'div','key':'updated','html':function(la){ return (lad[la].weeks[0].days==7 && lad[la].weeks[1].days==7 ? lad[la].weeks[0].upto+' vs '+lad[la].weeks[1].upto : "Missing data"); }}
		],
		'daily-percapita-graph': [
			{'tagname':'h3','key':'title','html':'Daily cases/100,000<br /><span class="small">Rolling 7-day average. Recent days are under-estimates.</span>'},
			{'tagname':'div','key':'graph','html':function(la){
				var i,j,data,smooth,n;
				data = new Array(lad[la].json.data.length);
				smooth = new Array(data.length);
				
				for(i = lad[la].json.data.length-1, j = 0; i>= 0; i--,j++){
					data[j] = {'x':(new Date(lad[la].json.data[i].date)).getTime(),'y':(lad[la].json.data[i]['newCasesBySpecimenDate']||0)};
				}
				// Calculate 7-day rolling average
				for(i = 0; i < data.length; i++){
					smooth[i] = {'x':data[i].x,'y':0};
					n = 0;
					for(j = i-3; j <= i+3; j++){
						if(j >=0 && j < data.length){
							smooth[i].y += data[j].y;
							n++;
						}
					}
					smooth[i].y /= n;
					if(pop[la]) smooth[i].y *= 1e5/pop[la];
				}
				graph = Graph();
				graph.addSeries({'title':'New cases','data':smooth,'raw':data,'color':'white','formatLabel':function(x,y,i){
					return (new Date(x)).toISOString().substr(0,10)+': '+y.toFixed(1)+'/100000 ('+this.raw[i].y+' cases)';
				},'stroke':1,'strokehover':3,'point':3,'pointhover':5,'line':1});
	
				return graph.draw({'width':240,'height':200,'left':15,'bottom':25,'axis':{'y':{'labels':{'left':25,'baseline':'middle'}},'x':{'line':1,'ticks':true}}});
			},'fit':true},
			{'tagname':'div','key':'updated','html':function(la){ return lad[la].json.data[0].date; }}
		],
		'weekly-deaths': [
			{'tagname':'h3','key':'title','html':'Weekly COVID-19 deaths'},
			{'tagname':'div','key':'number','html':function(la){ return (lad[la].deaths ? lad[la].deaths.week['covid-19'] : ''); },'fit':true},
			{'tagname':'div','key':'updated','html':function(la){ return (lad[la].deaths ? lad[la].deaths.week.text : '?'); }}
		],
		'total-deaths-covid': [
			{'tagname':'h3','key':'title','html':'Total COVID-19 deaths'},
			{'tagname':'div','key':'number','html':function(la){ return (lad[la].deaths ? lad[la].deaths.total['covid-19'] : ''); },'fit':true},
			{'tagname':'div','key':'updated','html':function(la){ return (lad[la].deaths ? lad[la].deaths.total.date : '?'); }}
		],
		'total-deaths-all': [
			{'tagname':'h3','key':'title','html':'Total deaths'},
			{'tagname':'div','key':'number','html':function(la){ return (lad[la].deaths ? lad[la].deaths.total['all'] : ''); },'fit':true},
			{'tagname':'div','key':'updated','html':function(la){ return (lad[la].deaths ? lad[la].deaths.total.date : ''); }}
		],
		'total-deaths-pc': [
			{'tagname':'h3','key':'title','html':'Total COVID-19 deaths as a percent of total deaths'},
			{'tagname':'div','key':'number','html':function(la){ return (lad[la].deaths ? Math.round(100*lad[la].deaths.total['covid-19']/lad[la].deaths.total['all'])+'%' : ''); },'fit':true},
			{'tagname':'div','key':'updated','html':function(la){ return (lad[la].deaths ? lad[la].deaths.total.date : ''); }}
		]
	}
	
	// Define populations
	var pop = {"E08000032":540909,"E08000033":210958,"E08000034":441772,"E08000035":795565,"E08000036":352983};

	// Define Local Authority Districts
	var auth = document.querySelectorAll('.authority');
	var lad = {};
	
	// Update styles
	var style = document.createElement('style');
	style.innerHTML = ".grid { grid-template-columns: repeat("+auth.length+", 1fr); }";
	for(var i = 0; i < auth.length; i++){
		la = auth[i].getAttribute('id');
		lad[la] = {};
		style.innerHTML += '.'+la+' { grid-column: '+(i+1)+' }';
	}
	// Set grid row styling
	i = 0;
	for(var id in panel){
		style.innerHTML += '.grid .row-'+(i+2)+' { grid-row: '+(i+2)+'; }';
		i++;
	}
	// Set media styling
	style.innerHTML += '@media only screen and (max-width: 640px) {';
	i = 0;
	for(var i = 0; i < auth.length; i++){
		la = auth[i].getAttribute('id');
		lad[la] = {};
		style.innerHTML += '.grid .'+la+' { grid-column: 1; }';
	}
	style.innerHTML += '.grid { grid-template-columns: 1fr;';
	style.innerHTML += '}'
	// append the style to the DOM in <head> section
	document.head.appendChild(style);




	// Identify panels in DOM and put in loading animations
	function initPanels(la){

		var i = 0;
		var existing = document.querySelectorAll('.'+la);

		for(var id in lad[la].panels){
			// Get a copy of the panels
			cpanels = lad[la].panels[id];
			// Update the structure
			lad[la].panels[id] = {'_parent':document.querySelector('.'+la+'.'+id)};

			if(!lad[la].panels[id]._parent){
				// Need to add this panel 
				if(existing.length > 0){
					var panel = document.createElement('div');
					panel.classList.add(la);
					panel.classList.add('cell');
					panel.classList.add('row-'+(i+2));
					panel.classList.add(id);
					panel.classList.add('padded');
					panel.setAttribute('tabindex',0);
					// Append it 
					existing[existing.length-1].insertAdjacentElement('afterend', panel);
					existing = [panel];
					lad[la].panels[id]._parent = panel;
				}
			}
			if(lad[la].panels[id]._parent){
				// Clear any contents
				lad[la].panels[id]._parent.innerHTML = "";
				// Create each area within each panel
				for(var p = 0; p < cpanels.length; p++){
					lad[la].panels[id][cpanels[p].key] = cpanels[p];
					lad[la].panels[id][cpanels[p].key].el = document.createElement(cpanels[p].tagname);
					lad[la].panels[id][cpanels[p].key].el.classList.add(cpanels[p]['key']);
					if(cpanels[p]['class']) lad[la].panels[id][cpanels[p].key].el.classList.add(cpanels[p]['class']);
					if(typeof cpanels[p].html==="string"){
						lad[la].panels[id][cpanels[p].key].el.innerHTML = cpanels[p].html;
					}else if(typeof cpanels[p].html==="function"){
						//lad[la].panels[id][panels[p].key].innerHTML = panels[p].html.call(this,la);
					}
					
					lad[la].panels[id]._parent.append(lad[la].panels[id][cpanels[p].key].el);
					if(cpanels[p]['key'] == "number"){
						// If we have a "number" area, put a loading animation in it
						load = document.createElement('img');
						load.src = "resources/odi.svg";
						load.classList.add('spinner');
						lad[la].panels[id][cpanels[p].key].el.append(load);
					}
				}
			}else{
				console.error("Can't find "+la+"."+id);
			}
			i++;
		}
		return;
	}
	function displayLA(la){

		if(!lad[la].json){
			console.error('No JSON for '+la);
			return;
		}
		// Work out weekly totals
		var latest = new Date(lad[la].json.data[0].date);
		var weeks = [{'total':0,'days':0,'upto':lad[la].json.data[0].date}];
		for(var i = 0; i < lad[la].json.data.length; i++){
			d = new Date(lad[la].json.data[i].date);
			w = Math.floor(((latest-d)/86400000)/7);
			if(weeks.length <= w) weeks.push({'total':0,'days':0,'upto':lad[la].json.data[i].date});
			weeks[w].total += lad[la].json.data[i]['newCasesBySpecimenDate'];
			weeks[w].days++;
		}
		lad[la].weeks = weeks;
		
		// Update the panels
		var v,id,bit;
		for(id in lad[la].panels){
			for(bit in lad[la].panels[id]){
				if(bit != "_parent"){
					v = "";
					if(typeof lad[la].panels[id][bit].html==="string") v = lad[la].panels[id][bit].html;
					else if(typeof lad[la].panels[id][bit].html==="function") v = lad[la].panels[id][bit].html.call(lad[la],la);
					
					if(bit == "number"){
						if(typeof v==="number"){
							animateNumber(lad[la].panels[id][bit].el,v,300,'','');
						}else{
							lad[la].panels[id][bit].el.innerHTML = v;
							//if(lad[la].panels[id][bit].fit) window.fitText(lad[la].panels[id][bit].el,0.7,{'len':v.length,'minFontSize':12,'minChar':4});
						}
					}else{
						lad[la].panels[id][bit].el.innerHTML = v;
					}
					if(lad[la].panels[id][bit].fit) window.fitText(lad[la].panels[id][bit].el,0.7,{'len':(v+"").length,'minFontSize':12,'minChar':4});
				}
			}
		}

		return this;
	}
	function getDataForLA(la){
		url = "https://api.coronavirus.data.gov.uk/v1/data?filters=areaType=ltla;areaCode={{LA}}&structure=%7B%22date%22:%22date%22,%22areaName%22:%22areaName%22,%22areaCode%22:%22areaCode%22,%22newCasesBySpecimenDate%22:%22newCasesBySpecimenDate%22,%22cumCasesBySpecimenDate%22:%22cumCasesBySpecimenDate%22%7D&format=json";
		lad[la].url = url;
		url = url.replace(/\{\{LA\}\}/,la);
		console.info('Getting data for '+la+' from '+url);
		lad[la].panels = clone(panel);
		initPanels(la);
		
		return fetch(url,{'method':'GET'})
		.then(response => { return response.json() })
		.then(json => {
			lad[la].json = json;
			//load.parentNode.removeChild(load);
			//displayLA(la);
		}).catch(error => {
			console.error(error,url);
			lad[la] = {};
		});
	}
	function formatNumber(v){
		if(typeof v !== "number") return v;
		if(v > 1e7) return Math.round(v/1e6)+"M";
		if(v > 1e6) return (v/1e6).toFixed(1)+"M";
		if(v > 1e5) return Math.round(v/1e3)+"k";
		if(v > 1e4) return Math.round(v/1e3)+"k";
		return v;
	}
	function animateNumber(el,val,duration,pre,post,callback){
		if(typeof val!=="number"){
			val = el.innerHTML;
			if(val) val = parseFloat(val);
			el.innerHTML = '';
		}
		el.innerHTML = '';
		if(!pre) pre = "";
		if(!post) post = "";
		var start = new Date();
		var v;
		function frame(){
			var now = new Date();
			// Set the current time in seconds
			var f = (now - start)/duration;
			if(f < 1){
				v = formatNumber(Math.round(val*f));
				el.innerHTML = (pre+v+post);
				requestAnimFrame(frame);
			}else{
				el.innerHTML = (pre+formatNumber(val)+post);
				if(typeof callback==="function") callback.call(el);
			}
		}
		if(typeof val==="number") frame();
		return;			
	}
	
	var promises = [];
	for(var la in lad) promises.push(getDataForLA(la));
	
	// Get death data (from other repo)
	promises.push(fetch("https://odileeds.github.io/covid-19/LocalAuthorities/data/death-summary.json",{'method':'GET'})
		.then(response => { return response.json() })
		.then(json => {
			for(var la in json){
				if(lad[la]) lad[la].deaths = json[la];
			}
		})
	);

	

	promises.map(p => p.catch(e => e));
	Promise.all(promises).then(responses => {
		for(var la in lad) displayLA(la);
	});
	</script>
</body>
</html>